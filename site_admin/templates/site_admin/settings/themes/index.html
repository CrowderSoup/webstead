{% extends "site_admin/base.html" %}
{% load static %}

{% block title %}Themes{% endblock %}
{% block head %}
  <script src="{% static 'js/theme_git_refs.js' %}"></script>
{% endblock %}

{% block content %}
  <div class="site-settings-layout grid gap-6 lg:grid-cols-[220px_1fr]">
    {% include "site_admin/settings/_sidebar.html" %}
    <div class="flex flex-col gap-6">
      <section class="flex flex-wrap items-center justify-between gap-4">
        <div>
          <div class="text-sm uppercase tracking-[0.2em] text-[color:var(--admin-muted)]">Site settings</div>
          <h1 class="text-2xl font-semibold">Themes</h1>
          <p class="mt-1 text-sm text-[color:var(--admin-muted)]">Upload new themes, edit files, and review installs.</p>
        </div>
        <div class="flex flex-wrap items-center gap-3">
          {% if active_theme_slug %}
            <a
              href="{% url 'site_admin:theme_file_edit' slug=active_theme_slug %}"
              class="rounded-full border border-[color:var(--admin-border)] px-4 py-2 text-sm font-semibold text-[color:var(--admin-ink)] transition hover:bg-[color:var(--admin-bg)]"
            >
              Edit active theme
            </a>
          {% endif %}
          <a
            href="{% url 'site_admin:site_settings' %}"
            class="rounded-full border border-[color:var(--admin-border)] px-4 py-2 text-sm font-semibold text-[color:var(--admin-ink)] transition hover:bg-[color:var(--admin-bg)]"
          >
            Back to general
          </a>
        </div>
      </section>

      {% if messages %}
        <section class="space-y-2">
          {% for message in messages %}
            {% if message.level_tag == "success" %}
              <div class="rounded-2xl border border-emerald-200 bg-emerald-50 px-4 py-3 text-sm text-emerald-700">
                {{ message }}
              </div>
            {% elif message.level_tag == "warning" %}
              <div class="rounded-2xl border border-amber-200 bg-amber-50 px-4 py-3 text-sm text-amber-700">
                {{ message }}
              </div>
            {% elif message.level_tag == "error" %}
              <div class="rounded-2xl border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700">
                {{ message }}
              </div>
            {% else %}
              <div class="rounded-2xl border border-blue-200 bg-blue-50 px-4 py-3 text-sm text-blue-700">
                {{ message }}
              </div>
            {% endif %}
          {% endfor %}
        </section>
      {% endif %}

      <section class="rounded-3xl border border-[color:var(--admin-border)] bg-[color:var(--admin-surface)] p-6 shadow-sm">
        <h2 class="text-lg font-semibold">Install theme</h2>
        <p class="mt-1 text-sm text-[color:var(--admin-muted)]">
          Add a theme from a zip archive or a public git repository. Files are synced to storage.
        </p>
        <form method="post" enctype="multipart/form-data" class="mt-4 space-y-4">
          {% csrf_token %}
          <input type="hidden" name="action" value="install_theme" />
          <div>
            <div class="text-xs uppercase tracking-wide text-[color:var(--admin-muted)]">Source</div>
            <div class="mt-2 inline-flex rounded-full border border-[color:var(--admin-border)] bg-[color:var(--admin-bg)] p-1">
              <button
                type="button"
                class="rounded-full px-4 py-1 text-xs font-semibold uppercase tracking-wide transition {% if install_source == 'git' %}bg-[color:var(--admin-accent)] text-white{% else %}text-[color:var(--admin-muted)]{% endif %}"
                data-install-source-button="git"
              >
                Git repository
              </button>
              <button
                type="button"
                class="rounded-full px-4 py-1 text-xs font-semibold uppercase tracking-wide transition {% if install_source == 'upload' %}bg-[color:var(--admin-accent)] text-white{% else %}text-[color:var(--admin-muted)]{% endif %}"
                data-install-source-button="upload"
              >
                Upload zip
              </button>
            </div>
            <input type="hidden" name="install_source" value="{{ install_source }}" data-install-source-input />
          </div>
          <div data-install-form data-install-source="upload" class="{% if install_source != 'upload' %}hidden{% endif %}">
            {{ upload_form.non_field_errors }}
            <div>
              {{ upload_form.archive.errors }}
              {{ upload_form.archive }}
              {% if upload_form.archive.help_text %}
                <p class="mt-2 text-xs text-[color:var(--admin-muted)]">{{ upload_form.archive.help_text }}</p>
              {% endif %}
            </div>
          </div>
          <div
            data-install-form
            data-install-source="git"
            data-git-ref-endpoint="{% url 'site_admin:theme_git_refs' %}"
            class="{% if install_source != 'git' %}hidden{% endif %}"
          >
            {{ git_form.non_field_errors }}
            <div>
              <label class="block text-xs uppercase tracking-wide text-[color:var(--admin-muted)]" for="{{ git_form.git_url.id_for_label }}">
                {{ git_form.git_url.label }}
              </label>
              {{ git_form.git_url.errors }}
              {{ git_form.git_url }}
              {% if git_form.git_url.help_text %}
                <p class="mt-2 text-xs text-[color:var(--admin-muted)]">{{ git_form.git_url.help_text }}</p>
              {% endif %}
            </div>
            <div class="mt-4 grid gap-4 sm:grid-cols-2">
              <div>
                <label class="block text-xs uppercase tracking-wide text-[color:var(--admin-muted)]" for="{{ git_form.slug.id_for_label }}">
                  {{ git_form.slug.label }}
                </label>
                {{ git_form.slug.errors }}
                {{ git_form.slug }}
              </div>
              <div>
                <label class="block text-xs uppercase tracking-wide text-[color:var(--admin-muted)]" for="{{ git_form.ref.id_for_label }}">
                  {{ git_form.ref.label }}
                </label>
                {{ git_form.ref.errors }}
                {{ git_form.ref }}
                <datalist id="theme-git-ref-options" data-git-ref-list></datalist>
                {% if git_form.ref.help_text %}
                  <p class="mt-2 text-xs text-[color:var(--admin-muted)]">{{ git_form.ref.help_text }}</p>
                {% endif %}
              </div>
            </div>
          </div>
          <button
            type="submit"
            class="rounded-full bg-[color:var(--admin-accent)] px-5 py-2 text-sm font-semibold text-white transition hover:bg-[color:var(--admin-accent-strong)]"
          >
            Install theme
          </button>
        </form>
      </section>

      <section class="rounded-3xl border border-[color:var(--admin-border)] bg-[color:var(--admin-surface)] p-6 shadow-sm">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div>
            <h2 class="text-lg font-semibold">Theme settings</h2>
            <p class="mt-1 text-sm text-[color:var(--admin-muted)]">
              Customize the active theme using its declared settings.
            </p>
          </div>
          {% if active_theme %}
            <div class="text-sm text-[color:var(--admin-muted)]">
              Active: <span class="font-semibold text-[color:var(--admin-ink)]">{{ active_theme.label }}</span>
            </div>
          {% endif %}
        </div>
        {% if theme_settings_form %}
          <form method="post" class="mt-4 space-y-6">
            {% csrf_token %}
            <input type="hidden" name="action" value="save_theme_settings" />
            {{ theme_settings_form.non_field_errors }}
            {% if theme_settings_groups %}
              {% for group in theme_settings_groups %}
                <div class="rounded-2xl border border-[color:var(--admin-border)] bg-[color:var(--admin-bg)] p-4">
                  <div class="text-xs font-semibold uppercase tracking-[0.2em] text-[color:var(--admin-muted)]">
                    {{ group.label }}
                  </div>
                  <div class="mt-4 grid gap-4 md:grid-cols-2">
                    {% for field in group.fields %}
                      <div>
                        <label class="block text-xs uppercase tracking-wide text-[color:var(--admin-muted)]" for="{{ field.id_for_label }}">
                          {{ field.label }}
                        </label>
                        {{ field.errors }}
                        {% if field.field.widget.input_type == "color" %}
                          <div class="mt-1 flex items-center gap-3" data-theme-color-row>
                            {{ field }}
                            <input
                              type="text"
                              class="w-28 rounded-2xl border-2 border-[color:var(--admin-border)] bg-white px-3 py-2 text-xs font-mono text-[color:var(--admin-ink)]"
                              value="{{ field.value|default:field.initial|default:'#000000' }}"
                              data-theme-color-value
                              readonly
                            />
                          </div>
                        {% else %}
                          {{ field }}
                        {% endif %}
                        {% if field.help_text %}
                          <p class="mt-2 text-xs text-[color:var(--admin-muted)]">{{ field.help_text }}</p>
                        {% endif %}
                      </div>
                    {% endfor %}
                  </div>
                </div>
              {% endfor %}
            {% endif %}
            {% if theme_settings_ungrouped_fields %}
              <div class="grid gap-4 md:grid-cols-2">
                {% for field in theme_settings_ungrouped_fields %}
                  <div>
                    <label class="block text-xs uppercase tracking-wide text-[color:var(--admin-muted)]" for="{{ field.id_for_label }}">
                      {{ field.label }}
                    </label>
                    {{ field.errors }}
                    {% if field.field.widget.input_type == "color" %}
                      <div class="mt-1 flex items-center gap-3" data-theme-color-row>
                        {{ field }}
                        <input
                          type="text"
                          class="w-28 rounded-2xl border-2 border-[color:var(--admin-border)] bg-white px-3 py-2 text-xs font-mono text-[color:var(--admin-ink)]"
                          value="{{ field.value|default:field.initial|default:'#000000' }}"
                          data-theme-color-value
                          readonly
                        />
                      </div>
                    {% else %}
                      {{ field }}
                    {% endif %}
                    {% if field.help_text %}
                      <p class="mt-2 text-xs text-[color:var(--admin-muted)]">{{ field.help_text }}</p>
                    {% endif %}
                  </div>
                {% endfor %}
              </div>
            {% endif %}
            <button
              type="submit"
              class="rounded-full bg-[color:var(--admin-accent)] px-5 py-2 text-sm font-semibold text-white transition hover:bg-[color:var(--admin-accent-strong)]"
            >
              Save theme settings
            </button>
          </form>
        {% else %}
          <div class="mt-4 rounded-2xl border border-dashed border-[color:var(--admin-border)] bg-[color:var(--admin-bg)] p-6 text-center text-sm text-[color:var(--admin-muted)]">
            {% if active_theme %}
              This theme does not define any custom settings.
            {% else %}
              Select an active theme to customize its settings.
            {% endif %}
          </div>
        {% endif %}
      </section>

      <script>
        document.addEventListener("DOMContentLoaded", () => {
          const rows = Array.from(document.querySelectorAll("[data-theme-color-row]"));
          rows.forEach((row) => {
            const picker = row.querySelector("input[type='color']");
            const value = row.querySelector("[data-theme-color-value]");
            if (!picker || !value) {
              return;
            }
            const sync = () => {
              const nextValue = picker.value || value.value;
              value.value = nextValue;
              value.style.borderColor = nextValue || "";
              value.style.backgroundColor = nextValue ? `${nextValue}1A` : "";
              value.style.boxShadow = nextValue ? `0 0 0 2px ${nextValue}33` : "";
            };
            sync();
            picker.addEventListener("input", sync);
            picker.addEventListener("change", sync);
          });

          const sourceInput = document.querySelector("[data-install-source-input]");
          const sourceButtons = Array.from(
            document.querySelectorAll("[data-install-source-button]")
          );
          if (sourceInput && sourceButtons.length) {
            const forms = Array.from(document.querySelectorAll("[data-install-form]"));
            const toggleForms = (selected) => {
              sourceInput.value = selected;
              forms.forEach((form) => {
                const isMatch = form.dataset.installSource === selected;
                form.classList.toggle("hidden", !isMatch);
              });
              sourceButtons.forEach((button) => {
                const isActive = button.dataset.installSourceButton === selected;
                button.classList.toggle("bg-[color:var(--admin-accent)]", isActive);
                button.classList.toggle("text-white", isActive);
                button.classList.toggle("text-[color:var(--admin-muted)]", !isActive);
              });
            };
            const initial = sourceInput.value || "git";
            toggleForms(initial);
            sourceButtons.forEach((button) => {
              button.addEventListener("click", () => {
                toggleForms(button.dataset.installSourceButton);
              });
            });
          }

        });
      </script>

      <section class="rounded-3xl border border-[color:var(--admin-border)] bg-[color:var(--admin-surface)] p-6 shadow-sm">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div>
            <h2 class="text-lg font-semibold">Themes inventory</h2>
            <p class="mt-1 text-sm text-[color:var(--admin-muted)]">Review installed themes, local presence, and sync status.</p>
          </div>
          <div class="flex flex-wrap items-center gap-3">
            <form method="post">
              {% csrf_token %}
              <input type="hidden" name="action" value="check_theme_storage" />
              <button
                type="submit"
                class="rounded-full border border-[color:var(--admin-border)] px-4 py-2 text-sm font-semibold text-[color:var(--admin-ink)] transition hover:bg-[color:var(--admin-bg)]"
              >
                Check storage for themes
              </button>
            </form>
          </div>
        </div>
        <form method="get" class="mt-4 flex flex-wrap items-end gap-4">
          <div>
            <label for="theme-inventory-source" class="block text-xs uppercase tracking-wide text-[color:var(--admin-muted)]">Source</label>
            <select
              name="source_type"
              id="theme-inventory-source"
              class="mt-1 w-full rounded-2xl border border-[color:var(--admin-border)] bg-white px-3 py-2 text-sm shadow-sm focus:border-[color:var(--admin-accent)] focus:ring-[color:var(--admin-accent)]"
            >
              <option value="">All</option>
              {% for value, label in source_choices %}
                <option value="{{ value }}" {% if filters.source_type == value %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label for="theme-inventory-status" class="block text-xs uppercase tracking-wide text-[color:var(--admin-muted)]">Status</label>
            <select
              name="status"
              id="theme-inventory-status"
              class="mt-1 w-full rounded-2xl border border-[color:var(--admin-border)] bg-white px-3 py-2 text-sm shadow-sm focus:border-[color:var(--admin-accent)] focus:ring-[color:var(--admin-accent)]"
            >
              <option value="">All</option>
              {% for value, label in status_choices %}
                <option value="{{ value }}" {% if filters.status == value %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label for="theme-inventory-search" class="block text-xs uppercase tracking-wide text-[color:var(--admin-muted)]">Search</label>
            <input
              type="text"
              name="q"
              value="{{ filters.q }}"
              id="theme-inventory-search"
              placeholder="Slug or source ref"
              class="mt-1 w-full rounded-2xl border border-[color:var(--admin-border)] bg-white px-3 py-2 text-sm shadow-sm focus:border-[color:var(--admin-accent)] focus:ring-[color:var(--admin-accent)]"
            />
          </div>
          <div class="flex gap-2">
            <button
              type="submit"
              class="rounded-full border border-[color:var(--admin-border)] px-4 py-2 text-sm font-semibold text-[color:var(--admin-ink)] transition hover:bg-[color:var(--admin-bg)]"
            >
              Filter
            </button>
            {% if filters.source_type or filters.status or filters.q %}
              <a
                href="{% url 'site_admin:theme_settings' %}"
                class="rounded-full border border-[color:var(--admin-border)] px-4 py-2 text-sm font-semibold text-[color:var(--admin-ink)] transition hover:bg-[color:var(--admin-bg)]"
              >
                Clear
              </a>
            {% endif %}
          </div>
        </form>
        {% if inventory_rows %}
          <div class="mt-4 overflow-x-auto">
            <table class="w-full table-fixed border border-[color:var(--admin-border)] text-sm">
              <thead>
                <tr class="bg-[color:var(--admin-bg)] text-left">
                  <th class="w-5/12 p-3 font-semibold">Theme</th>
                  <th class="w-5/12 p-3 font-semibold">Details</th>
                  <th class="w-2/12 p-3 font-semibold">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for row in inventory_rows %}
                  <tr class="border-t border-[color:var(--admin-border)]">
                    <td class="p-3">
                      <div class="flex flex-wrap items-center gap-2">
                        <span>{{ row.label }}</span>
                        {% if row.is_active %}
                          <span class="rounded-full bg-[color:var(--admin-bg)] px-2 py-1 text-xs font-semibold uppercase tracking-wide text-[color:var(--admin-muted)]">
                            Active
                          </span>
                        {% endif %}
                      </div>
                      <div class="mt-2 text-xs text-[color:var(--admin-muted)]">
                        <span class="font-mono">{{ row.slug }}</span>
                        <span class="mx-2 text-[color:var(--admin-border)]">â€¢</span>
                        <span>{{ row.version }}</span>
                      </div>
                    </td>
                    <td class="p-3">
                      <div class="flex flex-wrap gap-2 text-xs text-[color:var(--admin-muted)]">
                        <span>Author: {{ row.author }}</span>
                        <span>Files: {% if row.local_present %}{{ row.file_count }}{% else %}-{% endif %}</span>
                        {% if row.local_present %}
                          <span class="rounded-full bg-emerald-50 px-2 py-1 text-[10px] font-semibold uppercase tracking-wide text-emerald-700">Local</span>
                        {% else %}
                          <span class="rounded-full bg-rose-50 px-2 py-1 text-[10px] font-semibold uppercase tracking-wide text-rose-700">Missing locally</span>
                        {% endif %}
                        <span>Source: {{ row.source_label }}</span>
                        <span>Status: {{ row.install_status_label }}</span>
                        <span>Last synced: {{ row.last_synced_at|date:"Y-m-d H:i"|default:"-" }}</span>
                      </div>
                      {% if row.source_ref or row.source_url %}
                        <div class="mt-2 text-xs font-mono text-[color:var(--admin-muted)] break-all">
                          {{ row.source_ref|default:row.source_url }}
                        </div>
                      {% endif %}
                    </td>
                    <td class="p-3">
                      <div class="flex flex-wrap items-center gap-2">
                        {% if row.local_present %}
                          <a
                            href="{% url 'site_admin:theme_file_edit' slug=row.slug %}"
                            class="rounded-full border border-[color:var(--admin-border)] px-3 py-1 text-xs font-semibold text-[color:var(--admin-ink)] transition hover:bg-[color:var(--admin-bg)]"
                          >
                            Manage files
                          </a>
                        {% endif %}
                        {% if row.install %}
                          <a
                            href="{% url 'site_admin:theme_install_detail' slug=row.install.slug %}"
                            class="rounded-full border border-[color:var(--admin-border)] px-3 py-1 text-xs font-semibold text-[color:var(--admin-ink)] transition hover:bg-[color:var(--admin-bg)]"
                          >
                            Install info
                          </a>
                        {% endif %}
                      </div>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="mt-4 rounded-2xl border border-dashed border-[color:var(--admin-border)] bg-[color:var(--admin-bg)] p-6 text-center text-sm text-[color:var(--admin-muted)]">
            No themes found yet. Upload a theme or sync storage to get started.
          </div>
        {% endif %}
      </section>
    </div>
  </div>
{% endblock %}
